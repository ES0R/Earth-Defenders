#include "utility.h"
#include "player.h"
#include "time.h"
#include "world.h"
#include <string.h>
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>

//Function that clears screen
void clrscr() {

  uint8_t type = 2;
  printf("%c[%d;J", ESC, type);
}

//Function that goes to a specific location in the putty terminal
void gotoxy(uint8_t x, uint8_t y) {

  printf("%c[%d;%dH", ESC, y, x);
}

//Function that change the appearance of the cursor.
void cursortype(int8_t type) {

    if (type == 1) {
        printf("\e[?25l");
    }
    else{
        printf("\e[?25h");
    }
}

//Function that allows to read input from joystick
char readJoystick() {

    char z = 0;

    //Sets associated pins for every direction to input mode
    RCC->AHBENR |= RCC_AHBPeriph_GPIOC;

    GPIOC->MODER &= ~(0x00000003 << (0 * 2));
    GPIOC->MODER |= (0x00000000 << (0 * 2));

    GPIOC->PUPDR &= ~(0x00000003 << (0 * 2));
    GPIOC->PUPDR |= (0x00000002 << (0 * 2));

    uint16_t valR = GPIOC->IDR & (0x0001 << 0);

    RCC->AHBENR |= RCC_AHBPeriph_GPIOA;

    GPIOA->MODER &= ~(0x00000003 << (4 * 2));
    GPIOA->MODER |= (0x00000000 << (4 * 2));

    GPIOA->PUPDR &= ~(0x00000003 << (4 * 2));
    GPIOA->PUPDR |= (0x00000002 << (4 * 2));

    uint16_t valU = GPIOA->IDR & (0x0001 << 4);
    valU/=16;

    RCC->AHBENR |= RCC_AHBPeriph_GPIOB;

    GPIOB->MODER &= ~(0x00000003 << (5 * 2));
    GPIOB->MODER |= (0x00000000 << (5 * 2));

    GPIOB->PUPDR &= ~(0x00000003 << (5 * 2));
    GPIOB->PUPDR |= (0x00000002 << (5 * 2));

    uint16_t valC = GPIOB->IDR & (0x0001 << 5);
    valC/=32;

    RCC->AHBENR |= RCC_AHBPeriph_GPIOC;

    GPIOC->MODER &= ~(0x00000003 << (1 * 2));
    GPIOC->MODER |= (0x00000000 << (1 * 2));

    GPIOC->PUPDR &= ~(0x00000003 << (1 * 2));
    GPIOC->PUPDR |= (0x00000002 << (1 * 2));

    uint16_t valL = GPIOC->IDR & (0x0001 << 1);
    valL/=2;

    RCC->AHBENR |= RCC_AHBPeriph_GPIOB;

    GPIOB->MODER &= ~(0x00000003 << (0 * 2));
    GPIOB->MODER |= (0x00000000 << (0 * 2));

    GPIOB->PUPDR &= ~(0x00000003 << (0 * 2));
    GPIOB->PUPDR |= (0x00000002 << (0 * 2));

    uint16_t valD = GPIOB->IDR & (0x0001 << 0);

    z|= valU << 0;
    z|= valD << 1;
    z|= valL << 2;
    z|= valR << 3;
    z|= valC << 4;
    z|= 0 << 5;
    z|= 0 << 6;
    z|= 0 << 7;

    //Returns a value depending on the direction of the joystick
    return z;
}

//Function that controls the LED and its colors
void setLed(char j) {

    //Activates the LED depending on the input given to the function.
    //Has 3 used modes: Shut off, green and red

    //This part resets the LED. If J does not equal any of the below values, it defaults as shut off
    RCC->AHBENR |= RCC_AHBPeriph_GPIOB;
    RCC->AHBENR |= RCC_AHBPeriph_GPIOA;
    RCC->AHBENR |= RCC_AHBPeriph_GPIOC;

    GPIOB->MODER &= ~(0x00000003 << (4 * 2));
    GPIOB->MODER |= (0x00000000 << (4 * 2));

    GPIOC->MODER &= ~(0x00000003 << (7 * 2));
    GPIOC->MODER |= (0x00000000 << (7 * 2));

    GPIOA->MODER &= ~(0x00000003 << (9 * 2));
    GPIOA->MODER |= (0x00000000 << (9 * 2));

    if (j == 1) {

        GPIOB->OSPEEDR &= ~(0x00000003 << (4 * 2));
        GPIOB->OSPEEDR |= (0x00000002 << (4 * 2));
        GPIOB->OTYPER &= ~(0x0001 << (4));
        GPIOB->OTYPER |= (0x0000 << (4));
        GPIOB->MODER &= ~(0x00000003 << (4 * 2));
        GPIOB->MODER |= (0x00000001 << (4 * 2));
        GPIOB->ODR |= (0x0001 << 1);
    }

    if (j == 2) {

        GPIOC->OSPEEDR &= ~(0x00000003 << (7 * 2));
        GPIOC->OSPEEDR |= (0x00000002 << (7 * 2));
        GPIOC->OTYPER &= ~(0x0001 << (7));
        GPIOC->OTYPER |= (0x0000 << (7));
        GPIOC->MODER &= ~(0x00000003 << (7 * 2));
        GPIOC->MODER |= (0x00000001 << (7 * 2));
        GPIOC->ODR |= (0x0001 << 1);
    }

    if (j == 4) {

        GPIOA->OSPEEDR &= ~(0x00000003 << (9 * 2));
        GPIOA->OSPEEDR |= (0x00000002 << (9 * 2));
        GPIOA->OTYPER &= ~(0x0001 << (9));
        GPIOA->OTYPER |= (0x0000 << (9));
        GPIOA->MODER &= ~(0x00000003 << (9 * 2));
        GPIOA->MODER |= (0x00000001 << (9 * 2));
        GPIOA->ODR |= (0x0001 << 1);
    }
    if (j == 8) {

        GPIOA->OSPEEDR &= ~(0x00000003 << (9 * 2));
        GPIOA->OSPEEDR |= (0x00000002 << (9 * 2));
        GPIOA->OTYPER &= ~(0x0001 << (9));
        GPIOA->OTYPER |= (0x0000 << (9));
        GPIOA->MODER &= ~(0x00000003 << (9 * 2));
        GPIOA->MODER |= (0x00000001 << (9 * 2));
        GPIOA->ODR |= (0x0001 << 1);


        GPIOC->OSPEEDR &= ~(0x00000003 << (7 * 2));
        GPIOC->OSPEEDR |= (0x00000002 << (7 * 2));
        GPIOC->OTYPER &= ~(0x0001 << (7));
        GPIOC->OTYPER |= (0x0000 << (7));
        GPIOC->MODER &= ~(0x00000003 << (7 * 2));
        GPIOC->MODER |= (0x00000001 << (7 * 2));
        GPIOC->ODR |= (0x0001 << 1);
    }

    if (j == 16) {

        GPIOC->OSPEEDR &= ~(0x00000003 << (7 * 2));
        GPIOC->OSPEEDR |= (0x00000002 << (7 * 2));
        GPIOC->OTYPER &= ~(0x0001 << (7));
        GPIOC->OTYPER |= (0x0000 << (7));
        GPIOC->MODER &= ~(0x00000003 << (7 * 2));
        GPIOC->MODER |= (0x00000001 << (7 * 2));
        GPIOC->ODR |= (0x0001 << 1);


        GPIOB->OSPEEDR &= ~(0x00000003 << (4 * 2));
        GPIOB->OSPEEDR |= (0x00000002 << (4 * 2));
        GPIOB->OTYPER &= ~(0x0001 << (4));
        GPIOB->OTYPER |= (0x0000 << (4));
        GPIOB->MODER &= ~(0x00000003 << (4 * 2));
        GPIOB->MODER |= (0x00000001 << (4 * 2));
        GPIOB->ODR |= (0x0001 << 1);
    }
}

//Function that takes a string and a location and prints it on the LCD. Array provided by charset.c file
void lcd_write_string(char a[],int loc){

    const char ch[95][5] = {
    {0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x5F, 0x5F, 0x00, 0x00},
    {0x00, 0x07, 0x00, 0x07, 0x00},
    {0x14, 0x7F, 0x14, 0x7F, 0x14},
    {0x24, 0x2A, 0x7F, 0x2A, 0x12},
    {0x23, 0x13, 0x08, 0x64, 0x62},
    {0x36, 0x49, 0x55, 0x22, 0x50},
    {0x00, 0x05, 0x03, 0x00, 0x00},
    {0x00, 0x1C, 0x22, 0x41, 0x00},
    {0x00, 0x41, 0x22, 0x1C, 0x00},
    {0x14, 0x08, 0x3E, 0x08, 0x14},
    {0x08, 0x08, 0x3E, 0x08, 0x08},
    {0x00, 0x50, 0x30, 0x00, 0x00},
    {0x08, 0x08, 0x08, 0x08, 0x08},
    {0x00, 0x60, 0x60, 0x00, 0x00},
    {0x20, 0x10, 0x08, 0x04, 0x02},
    {0x3E, 0x51, 0x49, 0x45, 0x3E},
    {0x00, 0x42, 0x7F, 0x40, 0x00},
    {0x42, 0x61, 0x51, 0x49, 0x46},
    {0x22, 0x49, 0x49, 0x49, 0x36},
    {0x18, 0x14, 0x12, 0x7F, 0x10},
    {0x2F, 0x49, 0x49, 0x49, 0x31},
    {0x3E, 0x49, 0x49, 0x49, 0x32},
    {0x03, 0x01, 0x71, 0x09, 0x07},
    {0x36, 0x49, 0x49, 0x49, 0x36},
    {0x26, 0x49, 0x49, 0x49, 0x3E},
    {0x00, 0x36, 0x36, 0x00, 0x00},
    {0x00, 0x56, 0x36, 0x00, 0x00},
    {0x08, 0x14, 0x22, 0x41, 0x00},
    {0x14, 0x14, 0x14, 0x14, 0x14},
    {0x00, 0x41, 0x22, 0x14, 0x08},
    {0x02, 0x01, 0x51, 0x09, 0x06},
    {0x32, 0x49, 0x79, 0x41, 0x3E},
    {0x7C, 0x0A, 0x09, 0x0A, 0x7C},
    {0x7F, 0x49, 0x49, 0x49, 0x36},
    {0x3E, 0x41, 0x41, 0x41, 0x22},
    {0x7F, 0x41, 0x41, 0x41, 0x3E},
    {0x7F, 0x49, 0x49, 0x49, 0x41},
    {0x7F, 0x09, 0x09, 0x09, 0x01},
    {0x3E, 0x41, 0x49, 0x49, 0x7A},
    {0x7F, 0x08, 0x08, 0x08, 0x7F},
    {0x00, 0x41, 0x7F, 0x41, 0x00},
    {0x30, 0x40, 0x40, 0x40, 0x3F},
    {0x7F, 0x08, 0x14, 0x22, 0x41},
    {0x7F, 0x40, 0x40, 0x40, 0x40},
    {0x7F, 0x02, 0x0C, 0x02, 0x7F},
    {0x7F, 0x02, 0x04, 0x08, 0x7F},
    {0x3E, 0x41, 0x41, 0x41, 0x3E},
    {0x7F, 0x09, 0x09, 0x09, 0x06},
    {0x3E, 0x41, 0x51, 0x21, 0x5E},
    {0x7F, 0x09, 0x09, 0x09, 0x76},
    {0x26, 0x49, 0x49, 0x49, 0x32},
    {0x01, 0x01, 0x7F, 0x01, 0x01},
    {0x3F, 0x40, 0x40, 0x40, 0x3F},
    {0x1F, 0x20, 0x40, 0x20, 0x1F},
    {0x3F, 0x40, 0x38, 0x40, 0x3F},
    {0x63, 0x14, 0x08, 0x14, 0x63},
    {0x03, 0x04, 0x78, 0x04, 0x03},
    {0x61, 0x51, 0x49, 0x45, 0x43},
    {0x7F, 0x41, 0x41, 0x00, 0x00},
    {0x02, 0x04, 0x08, 0x10, 0x20},
    {0x00, 0x41, 0x41, 0x7F, 0x00},
    {0x04, 0x02, 0x01, 0x02, 0x04},
    {0x40, 0x40, 0x40, 0x40, 0x40},
    {0x00, 0x01, 0x02, 0x04, 0x00},
    {0x20, 0x54, 0x54, 0x54, 0x78},
    {0x7F, 0x48, 0x44, 0x44, 0x38},
    {0x38, 0x44, 0x44, 0x44, 0x20},
    {0x38, 0x44, 0x44, 0x48, 0x7F},
    {0x38, 0x54, 0x54, 0x54, 0x18},
    {0x08, 0x7E, 0x09, 0x01, 0x02},
    {0x0C, 0x52, 0x52, 0x52, 0x3E},
    {0x7F, 0x08, 0x04, 0x04, 0x78},
    {0x00, 0x44, 0x7D, 0x40, 0x00},
    {0x20, 0x40, 0x44, 0x3D, 0x00},
    {0x7F, 0x10, 0x28, 0x44, 0x00},
    {0x00, 0x41, 0x7F, 0x40, 0x00},
    {0x7C, 0x04, 0x18, 0x04, 0x78},
    {0x7C, 0x08, 0x04, 0x04, 0x78},
    {0x38, 0x44, 0x44, 0x44, 0x38},
    {0x7C, 0x14, 0x14, 0x14, 0x08},
    {0x08, 0x14, 0x14, 0x18, 0x7C},
    {0x7C, 0x08, 0x04, 0x04, 0x08},
    {0x48, 0x54, 0x54, 0x54, 0x20},
    {0x04, 0x3F, 0x44, 0x40, 0x20},
    {0x3C, 0x40, 0x40, 0x20, 0x7C},
    {0x1C, 0x20, 0x40, 0x20, 0x1C},
    {0x3C, 0x40, 0x38, 0x40, 0x3C},
    {0x44, 0x28, 0x10, 0x28, 0x44},
    {0x0C, 0x50, 0x50, 0x50, 0x3C},
    {0x44, 0x64, 0x54, 0x4C, 0x44},
    {0x00, 0x08, 0x36, 0x41, 0x00},
    {0x00, 0x00, 0x7F, 0x00, 0x00},
    {0x00, 0x41, 0x36, 0x08, 0x00},
    {0x08, 0x04, 0x08, 0x10, 0x08}};


    uint8_t arr[512];

    uint16_t j;

    for (j=0;j <= 512; j++) {

        arr[j]=0x00;
    }


    uint8_t i;

    //Places the letter on specific rows and column in order left to right
    for (i=0; i <= strlen(a)-1; i++){

        arr[loc +0 +(i*8)]=ch[a[i]-32][0];
        arr[loc +1 +(i*8)]=ch[a[i]-32][1];
        arr[loc +2 +(i*8)]=ch[a[i]-32][2];
        arr[loc +3 +(i*8)]=ch[a[i]-32][3];
        arr[loc +4 +(i*8)]=ch[a[i]-32][4];
    }
    //Sends array to show on LCD display
    lcd_push_buffer(arr);
}
